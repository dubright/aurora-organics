<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aurora Organics 🌿</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Inter",sans-serif;
      background:linear-gradient(180deg,#0c0f11 0%,#0f1115 100%);
      color:#e6e6e6;height:100vh;display:flex;overflow:hidden;
    }
    aside{
      width:240px;background:linear-gradient(180deg,#111315 0%,#0c0f11 100%);
      border-right:1px solid #1c1f22;padding:1.5rem;display:flex;
      flex-direction:column;gap:1rem;box-shadow:inset -1px 0 10px rgba(0,230,118,.05);
    }
    aside h1{font-size:1.3rem;color:#00e676;display:flex;align-items:center;gap:8px;text-shadow:0 0 6px rgba(0,230,118,.6)}
    .nav-btn{background:none;border:none;color:#e6e6e6;font-size:1rem;text-align:left;padding:10px;border-radius:8px;cursor:pointer;transition:.3s}
    .nav-btn.active,.nav-btn:hover{background:rgba(0,230,118,.08);color:#00e676;font-weight:600}
    main{flex:1;display:flex;overflow:hidden}
    .content{flex:1;padding:2rem;overflow-y:auto;background:radial-gradient(circle at top left,rgba(0,230,118,.08),transparent 60%)}
    .sidebar-right{width:320px;background:linear-gradient(180deg,#121417 0%,#0f1115 100%);border-left:1px solid #1d1f23;padding:1.2rem;overflow-y:auto}
    h2{color:#00e676;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:8px;margin-bottom:1rem;text-shadow:0 0 6px rgba(0,230,118,.5)}
    .card{background:rgba(23,26,31,.95);border-radius:12px;padding:1.2rem 1.5rem;margin-bottom:1rem;box-shadow:0 4px 20px rgba(0,230,118,.05);transition:.2s}
    .card:hover{transform:translateY(-2px)}
    select,input,button{border:none;border-radius:8px;padding:8px 10px;font-family:inherit}
    input,select{background:#1b1e22;color:#e6e6e6}
    button.action{background:#00e676;color:#000;font-weight:600;cursor:pointer;transition:.3s}
    button.action:hover{transform:scale(1.05)}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
    .metric-card{background:#121417;border:1px solid rgba(0,230,118,.15);border-radius:10px;padding:1rem;text-align:left;box-shadow:0 0 20px rgba(0,230,118,.03)}
    .metric-card h3{color:#e6e6e6;font-size:1rem;margin-bottom:.4rem}
    .metric-value{color:#00e676;font-weight:700;font-size:1.1rem;text-shadow:0 0 8px rgba(0,230,118,.6)}
    .progress{height:8px;background:#1f2329;border-radius:4px;overflow:hidden;margin-top:6px}
    .progress-bar{height:100%;background:linear-gradient(90deg,#00e676,#00b050);box-shadow:0 0 8px rgba(0,230,118,.5);transition:width .6s ease}
    .alert{background:rgba(255,51,51,.1);border:1px solid rgba(255,51,51,.3);border-left:4px solid #ff5252;color:#ff7b7b;padding:10px;border-radius:6px;font-size:.9rem;margin-top:10px}
    .section-title{font-weight:600;color:#00e676;margin-top:1rem;margin-bottom:.5rem;font-size:1.1rem}
    textarea{resize:none}
    .check-saved{animation:fadeCheck 1s ease-in-out}
    @keyframes fadeCheck{
      0%{opacity:0;transform:scale(.6)}
      30%{opacity:1;transform:scale(1.2)}
      100%{opacity:0;transform:scale(1)}
    }
    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-thumb{background:#00e67633;border-radius:8px}
    ::-webkit-scrollbar-thumb:hover{background:#00e67666}
  </style>
</head>
<body>
  <aside>
    <h1>🌿 Aurora</h1>
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="projects">Projetos</button>
  </aside>

  <main>
    <div class="content" id="root"></div>
    <div class="sidebar-right" id="insightsPanel">
      <h2>📊 Insights Inteligentes</h2>
      <div id="insights"></div>
    </div>
  </main>
  <script type="text/babel">
const { useState, useEffect } = React;

const plantas = [
  "Tomate 🍅","Alface 🥬","Cenoura 🥕","Rúcula 🌿",
  "Abobrinha","Abóbora 🎃","Pimentão 🌶️","Couve 🥬","Espinafre 🌱"
];
const fases = [
  { nome:"Germinação",icone:"🌱",dias:[0,7]},
  { nome:"Crescimento",icone:"🌿",dias:[8,35]},
  { nome:"Floração",icone:"🌸",dias:[36,50]},
  { nome:"Pré-colheita",icone:"🍅",dias:[51,60]},
  { nome:"Colheita",icone:"🌾",dias:[61,90]}
];
const formatDate = d => new Date(d).toLocaleDateString("pt-BR",{day:"2-digit",month:"short"});
const getFase = dias => fases.find(f=>dias>=f.dias[0]&&dias<=f.dias[1])||fases[0];
const calcularDosagem = l => {
  const ml=parseFloat(l);
  if(isNaN(ml))return"100ml";
  if(ml<=700)return"100ml";
  if(ml<=2000)return"250ml";
  if(ml<=5000)return"400ml";
  if(ml<=10000)return"600ml";
  return"1L";
};

function App({page}){
  const [projects,setProjects]=useState(JSON.parse(localStorage.getItem("projectsAurora")||"[]"));
  const [toast,setToast]=useState("");
  const [expanded,setExpanded]=useState(null);
  const [edits,setEdits]=useState({});
  const [savedFields,setSavedFields]=useState({}); // animação do check ✅

  // 💾 Salvamento com debounce
  useEffect(()=>{
    const t=setTimeout(()=>localStorage.setItem("projectsAurora",JSON.stringify(projects)),800);
    return()=>clearTimeout(t);
  },[projects]);

  const showToast=msg=>{
    setToast(msg);
    setTimeout(()=>setToast(""),2500);
  };

  const addProject=nome=>{
    if(!nome.trim())return alert("Informe um nome para o projeto.");
    const novo={id:Date.now(),nome,dataCriacao:new Date().toLocaleDateString(),cultivos:[]};
    setProjects([...projects,novo]);
    showToast("🌿 Projeto criado!");
  };

  const deleteProject=id=>{
    if(confirm("Excluir este projeto?")){
      setProjects(projects.filter(p=>p.id!==id));
      if(expanded===id)setExpanded(null);
      showToast("🗑️ Projeto removido.");
    }
  };

  const addCultivo=(projId,form)=>{
    const dataGerminacao=new Date(form.data);
    const novasTarefas=[];
    for(let i=0;i<60;i+=3){
      const dataT=new Date(dataGerminacao);dataT.setDate(dataT.getDate()+i);
      const tipo=(i%15===0&&i!==0)?"fertilizante":"água";
      novasTarefas.push({tipo,data:dataT.toISOString(),dosagem:calcularDosagem(form.litragem),concluida:false});
    }
    const novo={
      id:Date.now(),
      planta:form.planta,
      data:form.data,
      litragem:form.litragem,
      quantidade:form.quantidade,
      altura:0,folhas:0,produtividade:0,custo:0,pragas:"",
      tarefas:novasTarefas
    };
    setProjects(projects.map(p=>p.id===projId?{...p,cultivos:[...p.cultivos,novo]}:p));
    showToast("🌱 Cultivo adicionado!");
  };

  // ⚡ Edição local (buffer)
  const handleEdit=(projId,cultId,campo,valor)=>{
    setEdits(prev=>({...prev,[`${projId}-${cultId}-${campo}`]:valor}));
  };

  // 💧 Som + animação quando salvar
  const commitEdit=(projId,cultId,campo)=>{
    const valor=edits[`${projId}-${cultId}-${campo}`];
    if(valor!==undefined){
      setProjects(projects.map(p=>p.id===projId?{
        ...p,
        cultivos:p.cultivos.map(c=>c.id===cultId?{...c,[campo]:valor}:c)
      }:p));

      // ✅ Mostra check e toca som de gota d’água
      setSavedFields({[`${projId}-${cultId}-${campo}`]:true});
      const dropSound = new Audio("https://cdn.jsdelivr.net/gh/adam-nascimento/audio-feedbacks@main/drop-water.mp3");
      dropSound.volume = 0.35;
      dropSound.play();

      setTimeout(()=>setSavedFields({}),1200);
    }
  };
  function Projetos(){
    const [nome,setNome]=useState("");
    const [form,setForm]=useState({planta:"",data:"",litragem:"700ml",quantidade:1});
    return(
      <>
      <h2>🌿 Projetos</h2>
      <div style={{display:"flex",gap:"10px",marginBottom:"1rem"}}>
        <input placeholder="Nome do Projeto" value={nome} onChange={e=>setNome(e.target.value)}/>
        <button className="action" onClick={()=>{addProject(nome);setNome("");}}>+ Novo Projeto</button>
      </div>

      {projects.map(p=>(
        <div key={p.id} className="card">
          <div style={{display:"flex",justifyContent:"space-between"}}>
            <div>
              <strong>{p.nome}</strong>
              <div className="small">{p.cultivos.length} cultivos • criado em {p.dataCriacao}</div>
            </div>
            <div style={{display:"flex",gap:"8px"}}>
              <button className="action" onClick={()=>setExpanded(expanded===p.id?null:p.id)}>
                {expanded===p.id?"Fechar":"Abrir"}
              </button>
              <button className="action" onClick={()=>deleteProject(p.id)}>Excluir</button>
            </div>
          </div>

          {expanded===p.id&&(
            <div style={{marginTop:"1rem"}}>
              {/* === FORM DE NOVO CULTIVO === */}
              <div style={{display:"flex",gap:"8px",marginBottom:"1rem"}}>
                <select value={form.planta} onChange={e=>setForm({...form,planta:e.target.value})}>
                  <option value="">Planta</option>{plantas.map(pl=><option key={pl}>{pl}</option>)}
                </select>
                <input type="date" value={form.data} onChange={e=>setForm({...form,data:e.target.value})}/>
                <select value={form.litragem} onChange={e=>setForm({...form,litragem:e.target.value})}>
                  <option>700ml</option><option>2L</option><option>5L</option><option>10L</option><option>15L</option>
                </select>
                <input type="number" min="1" value={form.quantidade} onChange={e=>setForm({...form,quantidade:e.target.value})}/>
                <button className="action" onClick={()=>addCultivo(p.id,form)}>Adicionar</button>
              </div>

              {/* === LISTAGEM DE CULTIVOS === */}
              {p.cultivos.map(c=>{
                const dias=Math.floor((new Date()-new Date(c.data))/(1000*60*60*24));
                const fase=getFase(dias);
                const tarefasPendentes=c.tarefas.filter(t=>!t.concluida);
                const tarefasProximas=tarefasPendentes.filter(t=>{
                  const diasRest=Math.floor((new Date(t.data)-new Date())/(1000*60*60*24));
                  return diasRest<=5&&diasRest>=0;
                });
                const eficiencia=c.produtividade&&c.custo?(((c.produtividade-c.custo)/c.custo)*100).toFixed(1):0;

                return(
                  <div key={c.id} className="card">
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <strong>{c.planta}</strong><span>{fase.icone} {fase.nome}</span>
                    </div>
                    <div className="small">Germinação: {formatDate(c.data)} • Litragem: {c.litragem} • Qtd: {c.quantidade}</div>
                    <div className="progress"><div className="progress-bar" style={{width:`${(dias/60)*100}%`}}></div></div>

                    {/* === ALERTAS === */}
                    {tarefasProximas.length>0&&(
                      <div className="alert">
                        ⚠️ Tarefas próximas ({tarefasProximas.length}):
                        {tarefasProximas.map((t,i)=>(<div key={i}>• {t.tipo} — {t.dosagem} — {formatDate(t.data)}</div>))}
                      </div>
                    )}

                    {/* === CAMPOS DE DESENVOLVIMENTO === */}
                    <div className="section-title">🌱 Desenvolvimento</div>
                    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:"14px"}}>
                      {[
                        { label:"Altura", campo:"altura", unidade:"cm", icone:"📏" },
                        { label:"Folhas", campo:"folhas", unidade:"unid.", icone:"🌿" },
                        { label:"Produtividade", campo:"produtividade", unidade:"g", icone:"🍅" },
                        { label:"Custo", campo:"custo", unidade:"R$", icone:"💰" }
                      ].map(item=>(
                        <div key={item.campo}
                          style={{background:"#181a1d",border:"1px solid rgba(0,230,118,.15)",borderRadius:"10px",padding:"10px 12px",display:"flex",flexDirection:"column",boxShadow:"inset 0 0 10px rgba(0,230,118,.05)"}}>
                          <label style={{color:"#00e676",fontWeight:600,fontSize:".9rem",marginBottom:"4px"}}>
                            {item.icone} {item.label}
                          </label>
                          <div style={{display:"flex",alignItems:"center",background:"#1c1f22",borderRadius:"8px",overflow:"hidden",border:"1px solid rgba(0,230,118,.15)",position:"relative"}}>
                            <input
                              type="number"
                              min="0"
                              value={edits[`${p.id}-${c.id}-${item.campo}`]!==undefined?edits[`${p.id}-${c.id}-${item.campo}`]:c[item.campo]}
                              onChange={e=>handleEdit(p.id,c.id,item.campo,e.target.value)}
                              onBlur={()=>commitEdit(p.id,c.id,item.campo)}
                              style={{flex:1,padding:"8px 10px",background:"transparent",color:"#e6e6e6",border:"none",fontSize:"1rem",outline:"none"}}
                            />
                            <span style={{background:"#151718",padding:"8px 10px",color:"#00e676",fontWeight:600,borderLeft:"1px solid rgba(0,230,118,.15)"}}>{item.unidade}</span>
                            {savedFields[`${p.id}-${c.id}-${item.campo}`]&&(
                              <span className="check-saved" style={{position:"absolute",right:"35px",color:"#00e676"}}>✅</span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* === EFICIÊNCIA AGRONÔMICA === */}
                    <div className="section-title">⚙️ Eficiência Agronômica</div>
                    <div style={{display:"flex",gap:"10px",alignItems:"center"}}>
                      <div className="metric-value">{eficiencia}%</div>
                      {eficiencia<0&&<span style={{color:"#ff5252"}}>🚨 Prejuízo</span>}
                      {eficiencia>0&&<span style={{color:"#00e676"}}>✅ Lucro</span>}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      ))}
      </>
    );
  }

  // === DASHBOARD ===
  function Dashboard(){
    const todosCultivos=projects.flatMap(p=>p.cultivos);
    const totalPlantas=todosCultivos.length;
    const totalTarefas=todosCultivos.flatMap(c=>c.tarefas).length;
    const concluidas=todosCultivos.flatMap(c=>c.tarefas).filter(t=>t.concluida).length;
    const hoje=new Date();
    const pendentes=todosCultivos.flatMap(c=>c.tarefas).filter(t=>!t.concluida&&new Date(t.data)<hoje).length;
    const eficiencia=totalTarefas?((concluidas/totalTarefas)*100).toFixed(1):0;
    const producao=todosCultivos.reduce((a,c)=>a+(parseFloat(c.produtividade)||0),0);
    const custo=todosCultivos.reduce((a,c)=>a+(parseFloat(c.custo)||0),0);
    const rent=custo?(((producao*10-custo)/custo)*100).toFixed(1):0;

    // === GRÁFICOS E INSIGHTS ===
    useEffect(()=>{
      if(!todosCultivos.length)return;
      const ctx1=document.getElementById("graficoCrescimento");
      if(ctx1){
        new Chart(ctx1,{type:"line",data:{
          labels:["Sem1","Sem2","Sem3","Sem4"],
          datasets:[{data:[10,14,18,21],borderColor:"#00e676",tension:0.4}]
        },options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:"#ccc"}},y:{ticks:{color:"#ccc"}}}}});
      }
      const ctx2=document.getElementById("graficoUmidade");
      if(ctx2){
        new Chart(ctx2,{type:"bar",data:{labels:["Seg","Ter","Qua","Qui","Sex"],datasets:[{data:[58,60,63,61,59],backgroundColor:"#00b050"}]},options:{plugins:{legend:{display:false}}}});
      }
      const ctx3=document.getElementById("graficoEficiencia");
      if(ctx3){
        new Chart(ctx3,{type:"doughnut",data:{labels:["Eficiência"],datasets:[{data:[eficiencia,100-eficiencia],backgroundColor:["#00e676","#1b1e22"],borderWidth:0}]},options:{cutout:"75%",plugins:{legend:{display:false}}}});
      }

      // Atualiza painel lateral
      const insightsDiv=document.getElementById("insights");
      insightsDiv.innerHTML=`
        <div class='card'>🌱 Crescimento médio: <b>${(producao/totalPlantas||0).toFixed(1)}g</b></div>
        <div class='card'>💧 Eficiência: <b>${eficiencia}%</b></div>
        <div class='card'>📈 Rentabilidade média: <b>${rent}%</b></div>
        <div class='card'>🐛 Ocorrências registradas: <b>${todosCultivos.filter(c=>c.pragas).length}</b></div>`;
    },[projects]);

    return(<>
      <h2>📈 Dashboard Inteligente</h2>
      <div className="dashboard-grid">
        <div className="metric-card"><h3>🌿 Cultivos Ativos</h3><div className="metric-value">{totalPlantas}</div></div>
        <div className="metric-card"><h3>⚙️ Eficiência Operacional</h3><div className="metric-value">{eficiencia}%</div></div>
        <div className="metric-card"><h3>💰 Rentabilidade</h3><div className="metric-value">{rent}%</div></div>
        <div className="metric-card"><h3>🕓 Tarefas Pendentes</h3><div className="metric-value">{pendentes}</div></div>
      </div>

      {/* === GRÁFICOS === */}
      <div className="dashboard-grid" style={{marginTop:"2rem"}}>
        <div className="metric-card"><h3>📈 Crescimento</h3><canvas id="graficoCrescimento" height="100"></canvas></div>
        <div className="metric-card"><h3>💧 Umidade</h3><canvas id="graficoUmidade" height="100"></canvas></div>
        <div className="metric-card"><h3>⚙️ Eficiência</h3><canvas id="graficoEficiencia" height="100"></canvas></div>
      </div>

      {/* === ALERTAS === */}
      {eficiencia<60&&<div className="alert">⚠️ Eficiência baixa ({eficiencia}%). Verifique atrasos nas regas.</div>}
      {pendentes>0&&<div className="alert">🚨 {pendentes} tarefa(s) atrasada(s).</div>}
    </>);
  }

  // === RENDERIZAÇÃO FINAL ===
  return(<div>{page==="dashboard"?<Dashboard/>:<Projetos/>}{toast&&<div className="toast">{toast}</div>}</div>);
}

let currentPage="dashboard";
const root=ReactDOM.createRoot(document.getElementById("root"));
function renderApp(){root.render(<App page={currentPage}/>);}
renderApp();
document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentPage=btn.getAttribute("data-page");
    renderApp();
  };
});
  </script>
</body>
</html>
