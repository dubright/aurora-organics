<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aurora Organics üåø</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: #0f1115;
      color: #e6e6e6;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    aside {
      width: 230px;
      background: #121417;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    aside h1 {
      font-size: 1.25rem;
      color: #00e676;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-btn {
      background: none;
      border: none;
      color: #e6e6e6;
      font-size: 1rem;
      text-align: left;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    .nav-btn.active, .nav-btn:hover {
      background: #0f271d;
      color: #00e676;
    }
    main {
      flex: 1;
      display: flex;
      background: #0f1115;
      overflow: hidden;
    }
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    .sidebar-right {
      width: 280px;
      background: #121417;
      border-left: 1px solid #1d1f23;
      padding: 1rem;
      overflow-y: auto;
    }
    h2 { color: #00e676; margin-top: 0; }
    .card {
      background: #171a1f;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 230, 118, 0.05);
    }
    select, input, button {
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      font-family: inherit;
    }
    button.action {
      background: #00e676;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    button.action:hover { transform: scale(1.03); }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .progress {
      height: 8px;
      background: #1e2228;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar {
      height: 100%;
      transition: width 0.5s ease;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #00e676;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      animation: slideIn .5s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99;
    }
    .modal {
      background: #1b1e24;
      padding: 1.5rem;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .project-card {
      background: #1b1e24;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: 0.3s;
    }
    .project-card:hover { background: #1f2329; }
    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-icon {
      background: #00e676;
      border: none;
      border-radius: 6px;
      color: #000;
      font-weight: 600;
      padding: 6px 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-icon:hover { transform: scale(1.05); }
    .small { color: #a1a1a1; font-size: 0.85rem; }
    .panel-block { margin-bottom: 1rem; }
    .panel-item {
      background: #171a1f;
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
  </style>
</head>

<body>
  <aside>
    <h1>üåø Aurora</h1>
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="projects">Projetos</button>
  </aside>

  <main>
    <div class="content" id="root"></div>
    <div class="sidebar-right" id="sidePanel"></div>
  </main>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /* === CONFIGURA√á√ÉO DE PLANTAS COM CICLO M√âDIO E REGRAS === */
    const mapaPlantas = {
      "Alface": { ciclo: 45, agua: 2, fertilizante: 10 },
      "Tomate": { ciclo: 90, agua: 2, fertilizante: 7 },
      "Abobrinha": { ciclo: 70, agua: 2, fertilizante: 8 },
      "Beterraba": { ciclo: 60, agua: 3, fertilizante: 9 },
      "R√∫cula": { ciclo: 40, agua: 1, fertilizante: 10 },
      "Cenoura": { ciclo: 80, agua: 3, fertilizante: 10 },
      "Couve": { ciclo: 75, agua: 2, fertilizante: 7 },
      "Morango": { ciclo: 95, agua: 2, fertilizante: 6 },
      "Agri√£o": { ciclo: 50, agua: 1, fertilizante: 10 }
    };

    const fertilizantes = ["BioBizz", "Forth", "Dimy"];

    const fases = [
      { nome:"Germina√ß√£o", icone:"üå±", cor:"#00ff99", dias:[0,7] },
      { nome:"Crescimento", icone:"üåø", cor:"#00e676", dias:[8,35] },
      { nome:"Flora√ß√£o", icone:"üå∏", cor:"#c084fc", dias:[36,50] },
      { nome:"Pr√©-colheita", icone:"üçÖ", cor:"#fca311", dias:[51,60] }
    ];

    const getFase = dias => fases.find(f => dias >= f.dias[0] && dias <= f.dias[1]) || fases[0];
    const formatDate = d => new Date(d).toLocaleDateString("pt-BR",{ day:"2-digit", month:"short" });
    /* === GERADOR AUTOM√ÅTICO DE TAREFAS === */
    function gerarTarefas(planta, dataGerminacao) {
      const conf = mapaPlantas[planta];
      if (!conf) return [];
      const tarefas = [];
      const germinacao = new Date(dataGerminacao);
      const fim = new Date(germinacao);
      fim.setDate(fim.getDate() + conf.ciclo);

      for (let i = 0; i <= conf.ciclo; i++) {
        const data = new Date(germinacao);
        data.setDate(data.getDate() + i);
        if (i % conf.agua === 0)
          tarefas.push({ tipo: "üíß Rega com √°gua", data: data.toISOString(), status: "pendente" });
        if (i % conf.fertilizante === 0 && i !== 0)
          tarefas.push({ tipo: "üß™ Rega com fertilizante", data: data.toISOString(), status: "pendente" });
      }
      return tarefas;
    }

    /* === COMPONENTE PRINCIPAL === */
    function App({ page }) {
      const [projects, setProjects] = useState(JSON.parse(localStorage.getItem("projects") || "[]"));
      const [toast, setToast] = useState("");
      const [editProj, setEditProj] = useState(null);
      const [newName, setNewName] = useState("");
      const [expanded, setExpanded] = useState(null);
      const [selectedProjeto, setSelectedProjeto] = useState(null);

      useEffect(() => localStorage.setItem("projects", JSON.stringify(projects)), [projects]);
      const showToast = msg => { setToast(msg); setTimeout(() => setToast(""), 2500); };

      /* === FUN√á√ïES DE PROJETO === */
      const addProject = nome => {
        if (!nome.trim()) return alert("Informe um nome para o projeto.");
        const novo = { id: Date.now(), nome, dataCriacao: new Date().toLocaleDateString(), cultivos: [], historico: [] };
        setProjects([...projects, novo]);
        showToast("üåø Projeto criado!");
      };

      const deleteProject = id => {
        if (confirm("Excluir este projeto?")) {
          setProjects(projects.filter(p => p.id !== id));
          if (expanded === id) setExpanded(null);
          showToast("üóëÔ∏è Projeto removido.");
        }
      };

      const saveEdit = () => {
        setProjects(projects.map(p => p.id === editProj.id ? { ...p, nome: newName } : p));
        setEditProj(null);
        showToast("‚úèÔ∏è Projeto atualizado!");
      };

      /* === FUN√á√ïES DE CULTIVO === */
      const addCultivo = (projId, form) => {
        const tarefasAuto = gerarTarefas(form.planta, form.data);
        setProjects(projects.map(p =>
          p.id === projId
            ? {
                ...p,
                cultivos: [...p.cultivos, { ...form, id: Date.now(), historico: [], tarefas: tarefasAuto }],
                historico: [...p.historico, { data: new Date().toLocaleDateString(), acao: `üå± Cultivo de ${form.planta} adicionado` }]
              }
            : p
        ));
        showToast("üåæ Cultivo e tarefas criados!");
      };

      const concluirTarefa = (projId, cultId, index) => {
        setProjects(projects.map(p =>
          p.id === projId
            ? {
                ...p,
                cultivos: p.cultivos.map(c =>
                  c.id === cultId
                    ? {
                        ...c,
                        tarefas: c.tarefas.map((t,i)=> i===index ? {...t, status:"conclu√≠do"} : t)
                      }
                    : c
                )
              }
            : p
        ));
        showToast("‚úÖ Tarefa conclu√≠da!");
      };

      /* === DASHBOARD GERAL === */
      const allCultivos = selectedProjeto
        ? (projects.find(p=>p.id===parseInt(selectedProjeto))?.cultivos || [])
        : projects.flatMap(p => p.cultivos);

      const totalQ = allCultivos.reduce((a,b) => a + Number(b.quantidade||0), 0);
      const producao = totalQ * 1.5;
      const custo = totalQ * 5;
      const lucro = producao * 10;
      const rent = custo ? (((lucro - custo) / custo) * 100).toFixed(1) : 0;

      function Dashboard() {
        return (
          <>
            <h2>üìä Dashboard Inteligente</h2>
            <div className="form-group">
              <select value={selectedProjeto||""} onChange={e=>setSelectedProjeto(e.target.value)}>
                <option value="">Todos os Projetos</option>
                {projects.map(p=><option key={p.id} value={p.id}>{p.nome}</option>)}
              </select>
            </div>

            <div className="dashboard-cards">
              <div className="card"><h3>üåø Cultivos Ativos</h3><p>{allCultivos.length}</p></div>
              <div className="card"><h3>üì¶ Quantidade Total</h3><p>{totalQ}</p></div>
              <div className="card"><h3>‚öôÔ∏è Produ√ß√£o Estimada</h3><p>{producao.toFixed(1)} kg</p></div>
              <div className="card"><h3>üí∞ Lucro Estimado</h3><p>R$ {lucro.toFixed(2)}</p></div>
              <div className="card"><h3>üìà Rentabilidade</h3><p>{rent}%</p></div>
            </div>

            <h3 style={{marginTop:"2rem",color:"#00e676"}}>üóìÔ∏è Pr√≥ximas Tarefas</h3>
            {allCultivos.length>0 ? (
              allCultivos.flatMap(c=>c.tarefas||[])
              .filter(t=>new Date(t.data)>=new Date() && t.status==="pendente")
              .sort((a,b)=>new Date(a.data)-new Date(b.data))
              .slice(0,8)
              .map((t,i)=>(
                <div key={i} className="panel-item">
                  <strong>{t.tipo}</strong> ‚Äî {new Date(t.data).toLocaleDateString("pt-BR")}
                </div>
              ))
            ) : <div className="small">Nenhuma tarefa pendente.</div>}
          </>
        );
      }
      /* === ABA DE PROJETOS === */
      function Projetos() {
        const [nome, setNome] = useState("");
        const [form, setForm] = useState({ planta:"", data:"", fertilizante:"BioBizz", litragem:"700ml", quantidade:1 });
        const projetoAtual = projects.find(p => p.id === expanded);

        return (
          <>
            <h2>üåø Projetos</h2>
            <div className="form-group">
              <input placeholder="Nome do Projeto" value={nome} onChange={e=>setNome(e.target.value)} />
              <button className="action" onClick={()=>{addProject(nome); setNome("");}}>+ Novo Projeto</button>
            </div>

            {projects.map(p => (
              <div key={p.id} className="project-card">
                <div className="project-header" onClick={()=>setExpanded(expanded===p.id?null:p.id)}>
                  <div>
                    <strong>{p.nome}</strong>
                    <div className="small">{p.cultivos.length} cultivos ‚Ä¢ criado em {p.dataCriacao}</div>
                  </div>
                  <div style={{display:"flex",gap:"6px"}}>
                    <button className="btn-icon" onClick={e=>{e.stopPropagation(); setEditProj(p); setNewName(p.nome);}}>‚úèÔ∏è</button>
                    <button className="btn-icon" onClick={e=>{e.stopPropagation(); deleteProject(p.id);}}>üóëÔ∏è</button>
                  </div>
                </div>

                {expanded===p.id && (
                  <div style={{marginTop:"1rem"}}>
                    {/* FORM DE CULTIVO */}
                    <div className="form-group">
                      <select value={form.planta} onChange={e=>setForm({...form,planta:e.target.value})}>
                        <option value="">Planta</option>
                        {Object.keys(mapaPlantas).map(pl=><option key={pl}>{pl}</option>)}
                      </select>
                      <input type="date" value={form.data} onChange={e=>setForm({...form,data:e.target.value})}/>
                      <select value={form.fertilizante} onChange={e=>setForm({...form,fertilizante:e.target.value})}>
                        {fertilizantes.map(f=><option key={f}>{f}</option>)}
                      </select>
                      <select value={form.litragem} onChange={e=>setForm({...form,litragem:e.target.value})}>
                        <option>700ml</option><option>5L</option><option>10L</option><option>15L</option>
                      </select>
                      <input type="number" min="1" value={form.quantidade} onChange={e=>setForm({...form,quantidade:e.target.value})}/>
                      <button className="action" onClick={()=>{
                        if(!form.planta||!form.data) return alert("Preencha todos os campos!");
                        addCultivo(p.id, form);
                        setForm({planta:"",data:"",fertilizante:"BioBizz",litragem:"700ml",quantidade:1});
                        setExpanded(p.id);
                      }}>Adicionar</button>
                    </div>

                    {/* CULTIVOS ATIVOS */}
                    {p.cultivos.map(c=>{
                      const dias=Math.floor((new Date()-new Date(c.data))/(1000*60*60*24));
                      const fase=getFase(dias);
                      const prog=Math.min((dias/(mapaPlantas[c.planta]?.ciclo||60))*100,100);
                      return(
                        <div key={c.id} className="card">
                          <div style={{display:"flex",justifyContent:"space-between"}}>
                            <strong>{c.planta}</strong><span>{c.fertilizante}</span>
                          </div>
                          <div className="small">üå± Germina√ß√£o: {formatDate(c.data)} | {fase.icone} {fase.nome}</div>
                          <div className="progress"><div className="progress-bar" style={{width:`${prog}%`,background:fase.cor}}></div></div>
                          <div className="small">üíß Litragem: {c.litragem} | üì¶ Quantidade: {c.quantidade}</div>
                          <div className="form-group">
                            <button className="action" onClick={()=>registrar(p.id,c.id,"‚úÖ Aduba√ß√£o realizada")}>Aplicar</button>
                            <button className="action" onClick={()=>deleteCultivo(p.id,c.id)}>Excluir</button>
                          </div>

                          {/* TAREFAS AUTOM√ÅTICAS */}
                          {c.tarefas && c.tarefas.length>0 && (
                            <div className="small">
                              <strong>üßæ Tarefas Programadas:</strong>
                              {c.tarefas.slice(0,4).map((t,i)=>(
                                <div key={i} style={{marginTop:"3px"}}>
                                  {new Date(t.data).toLocaleDateString("pt-BR")} ‚Äî {t.tipo} {t.status==="conclu√≠do"?"‚úÖ":""}
                                  {t.status==="pendente" && (
                                    <button className="btn-icon" style={{marginLeft:"6px",padding:"3px 8px"}}
                                      onClick={()=>concluirTarefa(p.id,c.id,i)}>‚úî</button>
                                  )}
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            ))}

            {/* MODAL DE EDI√á√ÉO */}
            {editProj && (
              <div className="modal-bg" onClick={()=>setEditProj(null)}>
                <div className="modal" onClick={e=>e.stopPropagation()}>
                  <h3>Editar Projeto</h3>
                  <input value={newName} onChange={e=>setNewName(e.target.value)} style={{width:"100%",marginBottom:"10px"}}/>
                  <div style={{display:"flex",gap:"10px",justifyContent:"flex-end"}}>
                    <button className="action" onClick={saveEdit}>Salvar</button>
                    <button className="action" onClick={()=>setEditProj(null)}>Cancelar</button>
                  </div>
                </div>
              </div>
            )}

            {/* PAINEL LATERAL */}
            {ReactDOM.createPortal(
              <div>
                {projetoAtual ? (
                  <>
                    <div className="panel-block">
                      <h4 style={{color:"#00e676"}}>üìä Panorama</h4>
                      <div>üåæ Cultivos: {projetoAtual.cultivos.length}</div>
                      <div>üì¶ Quantidade Total: {projetoAtual.cultivos.reduce((a,b)=>a+Number(b.quantidade||0),0)}</div>
                    </div>

                    <div className="panel-block">
                      <h4 style={{color:"#00e676"}}>üßæ Tarefas Autom√°ticas</h4>
                      {projetoAtual.cultivos.flatMap(c=>c.tarefas||[])
                        .filter(t=>t.status==="pendente" && new Date(t.data)>=new Date())
                        .slice(0,8)
                        .map((t,i)=><div key={i} className="panel-item">{t.tipo} ‚Äî {new Date(t.data).toLocaleDateString("pt-BR")}</div>)
                      }
                    </div>

                    <div className="panel-block">
                      <h4 style={{color:"#00e676"}}>üïì Hist√≥rico</h4>
                      {projetoAtual.historico.slice(-10).reverse().map((h,i)=><div key={i} className="panel-item">{h.data} ‚Äî {h.acao}</div>)}
                    </div>
                  </>
                ) : (
                  <div className="small" style={{opacity:0.7,marginTop:"2rem"}}>Selecione um projeto para visualizar o painel</div>
                )}
              </div>,
              document.getElementById("sidePanel")
            )}
          </>
        );
      }

      return (
        <div>
          {page==="dashboard" ? <Dashboard/> : <Projetos/>}
          {toast && <div className="toast">{toast}</div>}
        </div>
      );
    }

    /* === RENDERIZA√á√ÉO === */
    let currentPage="dashboard";
    const root=ReactDOM.createRoot(document.getElementById("root"));
    const side=document.getElementById("sidePanel");

    function renderApp() {
      if (currentPage === "dashboard") side.innerHTML = "";
      root.render(<App key={currentPage} page={currentPage} />);
    }

    renderApp();

    document.querySelectorAll(".nav-btn").forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentPage=btn.getAttribute("data-page");
        renderApp();
      };
    });
  </script>
</body>
</html>
